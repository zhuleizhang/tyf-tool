name: 构建HeartGuardian

on:
  push:
    branches: [main, master]
    paths:
      - "scripts/HeartGuardian.py" # 仅当HeartGuardian.py有变更时触发
      - ".github/workflows/build-heart-guardian.yml" # 仅当build-heart-guardian.yml有变更时触发
  # pull_request:
  #   branches: [main, master]
  #   paths:
  #     - "scripts/HeartGuardian.py" # 仅当HeartGuardian.py有变更时触发
  # 允许手动触发工作流
  workflow_dispatch:

jobs:
  # 构建Mac Intel版本
  build-mac-intel:
    # runs-on: macos-11 # 使用较旧的macOS运行器
    runs-on: macos-13 # 使用Intel架构的macOS 13 runner
    # 对于大型Intel运行器(需要特定计划)，可以使用:
    # runs-on: macos-13-large
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 打印芯片架构信息
        run: |
          # 检查CPU架构
          echo "CPU架构: $(uname -m)"
          echo "芯片: $(sysctl -n machdep.cpu.brand_string)"

      - name: Install Python 3.9 (compiled for macOS 12)
        run: |
          brew install pyenv

          # 1. 确保卸载已有的 Python 3.9.18（避免残留旧版本）
          pyenv uninstall -f 3.9.18 || true
          rm -rf ~/.pyenv/sources/3.9.18
          rm -rf ~/.pyenv/versions/3.9.18

          # 2. 关键：设置编译环境变量，强制适配 macOS 12（必须在安装 Python 前设置）
          export MACOSX_DEPLOYMENT_TARGET=12.0
          export CFLAGS="-mmacosx-version-min=12.0 -D_DARWIN_C_SOURCE"
          export CXXFLAGS="-mmacosx-version-min=12.0 -D_DARWIN_C_SOURCE"
          export LDFLAGS="-mmacosx-version-min=12.0"

          # 3. 用 pyenv 安装 Python 3.9.18（此时会应用上述环境变量编译，确保适配 macOS 12）
          pyenv install 3.9.18

          # 4. 切换到 pyenv 安装的 Python 3.9.18，确保后续步骤使用该版本
          pyenv global 3.9.18
          PYENV_PYTHON_PATH=$(pyenv which python)
          echo "使用的 Python 路径: $PYENV_PYTHON_PATH"
          echo "$(pyenv root)/shims" >> $GITHUB_PATH  # 确保 pyenv 的 Python 优先级最高

          # 5. 修正：直接拼接 pyenv 安装路径下的 libpython3.9.dylib（避免路径检测错误）
          PYTHON_LIB_DIR="$HOME/.pyenv/versions/3.9.18/lib"
          PYTHON_LIB="$PYTHON_LIB_DIR/libpython3.9.dylib"
          echo "Python 共享库路径: $PYTHON_LIB"

      - name: Set deployment target
        run: |
          echo "MACOSX_DEPLOYMENT_TARGET=12.0" >> $GITHUB_ENV

      - name: 安装依赖
        run: |
          # 安装打包所需的依赖
          pip install pyinstaller requests pillow
          # 确保安装了tkinter（在某些环境中可能需要单独安装）
          python -c "import tkinter; print('tkinter is installed')" || echo "Warning: tkinter might not be properly installed, which may cause UI display issues"

      - name: 构建前环境检查
        run: |
          # 检查Python版本和路径
          python --version
          which python
          # 检查依赖是否正确安装
          pip list | grep -E 'pyinstaller|requests|pillow'
          # 检查图标文件是否存在
          test -f src/assets/HeartGuardian.png && echo "Icon file exists" || echo "Warning: Icon file does not exist, default icon will be used"
          test -f src/assets/logo.icns && echo "Backup icns icon exists" || echo "Backup icns icon does not exist"

      - name: 构建Mac Intel版本
        run: |
          # 直接打包HeartGuardian.py脚本并指定PNG图标
          cd scripts
          # 尝试使用PNG图标，如果失败则尝试使用icns图标作为备选
          PYTHONHASHSEED=1 pyinstaller --onefile --windowed --name HeartGuardian --icon ../src/assets/HeartGuardian.png HeartGuardian.py || \
          PYTHONHASHSEED=1 pyinstaller --onefile --windowed --name HeartGuardian --icon ../src/assets/logo.icns HeartGuardian.py
          mkdir -p ../dist/mac-intel
          cp -f dist/HeartGuardian ../dist/mac-intel/

      - name: 上传Mac Intel构建结果
        uses: actions/upload-artifact@v4
        with:
          name: mac-intel-binaries
          path: dist/mac-intel
          retention-days: 7

  # 构建Mac ARM版本
  build-mac-arm:
    runs-on: macos-14 # 使用ARM架构的macOS runner
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 打印芯片架构信息
        run: |
          # 检查CPU架构
          echo "CPU架构: $(uname -m)"
          echo "芯片: $(sysctl -n machdep.cpu.brand_string)"

      - name: 设置Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"
          cache: "pip"

      - name: 安装依赖
        run: |
          # 安装打包所需的依赖
          pip install pyinstaller requests pillow

      - name: 构建前环境检查
        run: |
          # 检查Python版本和路径
          python --version
          which python
          # 检查依赖是否正确安装
          pip list | grep -E 'pyinstaller|requests|pillow'
          # 检查图标文件是否存在
          test -f src/assets/HeartGuardian.png && echo "Icon file exists" || echo "Warning: Icon file does not exist, default icon will be used"
          test -f src/assets/logo.icns && echo "Backup icns icon exists" || echo "Backup icns icon does not exist"

      - name: 构建Mac ARM版本
        run: |
          # 直接打包HeartGuardian.py脚本并指定PNG图标
          cd scripts
          # 尝试使用PNG图标，如果失败则尝试使用icns图标作为备选
          PYTHONHASHSEED=1 pyinstaller --onefile --windowed --name HeartGuardian --icon ../src/assets/HeartGuardian.png HeartGuardian.py || \
          PYTHONHASHSEED=1 pyinstaller --onefile --windowed --name HeartGuardian --icon ../src/assets/logo.icns HeartGuardian.py
          mkdir -p ../dist/mac-arm
          cp -f dist/HeartGuardian ../dist/mac-arm/

      - name: 上传Mac ARM构建结果
        uses: actions/upload-artifact@v4
        with:
          name: mac-arm-binaries
          path: dist/mac-arm
          retention-days: 7

  # 构建Windows版本
  build-windows:
    runs-on: windows-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"
          cache: "pip"

      - name: 安装依赖
        run: |
          # 安装打包所需的依赖和tkinter支持
          pip install pyinstaller requests pillow
          # Windows通常默认安装tkinter，但进行检查确保（使用英文避免编码问题）
          python -c "import tkinter; print('tkinter is installed')" || echo "Warning: tkinter might not be properly installed, which may cause UI display issues"

      - name: 构建前环境检查
        run: |
          # 检查Python版本和路径
          python --version
          where python
          # 检查依赖是否正确安装
          pip list | findstr -i "pyinstaller requests pillow"
          # 检查图标文件是否存在（使用英文避免编码问题）
          if exist ..\src\assets\HeartGuardian.png (echo "Icon file exists") else (echo "Warning: Icon file does not exist, default icon will be used")
          if exist ..\src\assets\logo.ico (echo "Backup ico icon exists") else (echo "Backup ico icon does not exist")

      - name: 构建Windows版本
        run: |
          # 直接打包HeartGuardian.py脚本并指定PNG图标
          cd scripts
          # 尝试使用PNG图标，如果失败则尝试使用ico图标作为备选
          set PYTHONHASHSEED=1 && pyinstaller --onefile --windowed --name HeartGuardian --icon ..\src\assets\HeartGuardian.png HeartGuardian.py || \
          set PYTHONHASHSEED=1 && pyinstaller --onefile --windowed --name HeartGuardian --icon ..\src\assets\logo.ico HeartGuardian.py
          mkdir -p ../dist/windows
          copy dist\HeartGuardian.exe ..\dist\windows\

      - name: 上传Windows构建结果
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: dist/windows
          retention-days: 7
